using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using TMPro;
using Packet.GameServer;
using UnityEngine.UI;
using System.Threading.Tasks;
using System;
using UnityEngine.EventSystems;

public class LobbyCanvas : MonoBehaviour, IPointerDownHandler
{
    [Tooltip("TopPanel에 붙는 UI들")]
    [SerializeField] private TMP_Text nameTxt;
    [SerializeField] private TMP_Text goldTxt;

    //특수 Panel관련 바인딩 -> 특수 패널은 오로지 1개만 열려야 하는 패널이다 (해당 특수끼린 열리는게 독립적이다)
    [SerializeField] private List<GameObject> PanelList; //특수 패널을 담은 list

    private Dictionary<UIType, GameObject> PanelDictionary = new Dictionary<UIType, GameObject>(); //패널의 key를 부여해 저장
    private Queue<GameObject> PanelActiveQueue = new Queue<GameObject>(); //SetActive시 Queue에 넣고 맨 앞은 지우고 오로지 1개만 열리게 저장

    private void Start()
    {
        InitaDictionary();
        LoadUserInfo();
    }


    /// <summary>
    /// Login 되었을 때, User의 Info를 가져온다
    /// Login시 PlayerPrefs와 Server에 저장했으니 둘이 같은 정보로
    /// PlayerPrefs에서 user의 정보를 꺼내와서 붙여준다.
    /// </summary>
    private void LoadUserInfo()
    {
        if (GameServer.GetInstance.IsLogin)
        {
            nameTxt.text = LocalData.GetInstance.Name;
            goldTxt.text = LocalData.GetInstance.Gold.ToString();
        }
    }

    /// <summary>
    /// middle panel 추가하여 터치를 받는 함수
    /// 다른 Panel이 열린상태에서 이 공간을 터치하면 모두 다 닫히도록 설정
    /// pointerEnter가 아니라 pointerClick으로 하면 터치 받는 시스템이 달라서 그런지 Null나온다
    /// </summary>
    /// <param name="eventData"></param>
    public void OnPointerDown(PointerEventData eventData)
    {
        if (eventData.pointerEnter.gameObject.CompareTag("ImportantPanel"))
        {
            OpenPanel(UIType.NonePanel);
        }
    }
    
    #region 특수 Panel 컨트롤하는 Button 함수
    /// <summary>
    /// LobbyCanvas의 Bottom Panel밑에 Inventory Button에 직접 연결중
    /// Inventory Button을 누르면 Inventory를 연다.
    /// </summary>
    public void InventoryPanelOpen()
    {
        OpenPanel(UIType.InventoryPanel);
    }

    /// <summary>
    /// LobbyCanvas의 Bottom Panel밑에 PlayMode Button에 직접 연결중
    /// PlayMode Button을 누르면 호출된다
    /// </summary>
    public void PlayModePanelOpen()
    {
        OpenPanel(UIType.PlayModePanel);
    }

    /// <summary>
    /// LobbyCanvas의 Bottom Panel밑에 Option Button에 직접 연결중
    /// Option Button을 누르면 호출된다
    /// </summary>
    public void OptionPanelOpen()
    {
        OpenPanel(UIType.OptionPanel);
    }
    #endregion

    #region Button에 직접 연결한 Function
    /// <summary>
    /// PlayMode Panel 밑 MultiPlay Button에 직접 연결중
    /// MultiPlay Button을 누르면 매칭을 진행한다.
    /// </summary>
    public async void GoToMultiPlay()
    {
        if (GameServer.GetInstance.IsLogin)
        {
            SceneController.GetInstance.GoToScene("MultiPlay");
            await MatchManager.GetInstance.MatchSetup();
            GameManager.GetInstance.GameStart();
        }
    }

    /// <summary>
    /// PlayMode Panel 밑 SinglePlay Button에 직접 연결중
    /// SinglePlay Button을 누르면 싱글 플레이를 진행한다.
    /// </summary>
    public void GoToSinglePlay()
    {
        SceneController.GetInstance.GoToScene("SinglePlay");
        GameManager.GetInstance.GameStart();
    }

    /// <summary>
    /// Option Panel 밑 Save Button에 직접 연결중
    /// Save Button을 누르면 유저 정보를 저장한다.
    /// 서버가 연결되어 있으면 DB서버에 유저 정보 갱신한다.
    /// </summary>
    public void SaveUserInfo()
    {
        string name = nameTxt.text;
        int gold = int.Parse(goldTxt.text);

        LocalData.GetInstance.Name = name;
        LocalData.GetInstance.Gold = gold;

        if (GameServer.GetInstance.IsLogin)
        {
            MatchManager.GetInstance.SaveUserInfoServer(name, gold);
        }
    }

    /// <summary>
    /// Option Panel 밑 Clear Button에 직접 연결중
    /// Clear Button을 누르면 유저 정보를 삭제한다.
    /// </summary>
    public void ClearUserInfo()
    {
        LocalData.GetInstance.ClearAllUserInfo();
        SceneController.GetInstance.GoToScene("Login");
    }
    #endregion

    #region 특수 Panel관련 함수들
    /// <summary>
    /// Lobby Scene 진입시, 패널 세팅
    /// </summary>
    private void InitaDictionary()
    {
        foreach (GameObject panel in PanelList)
        {
            switch (panel.gameObject.name)
            {
                case "Inventory Panel":
                    PanelDictionary.Add(UIType.InventoryPanel, panel);
                    break;
                case "PlayMode Panel":
                    PanelDictionary.Add(UIType.PlayModePanel, panel);
                    break;
                case "Option Panel":
                    PanelDictionary.Add(UIType.OptionPanel, panel);
                    break;
            }
        }
    }

    /// <summary>
    /// LobbyScene에서 LobbyCanvas에서 입력을 받아서 해당 씬의 패널을 처리해준다
    /// </summary>
    /// <param name="type"> Open할 Panel의 Type을 받는다 </param>
    /// <param name="layer"> Canvas의 위치를 받아 자식으로 넣는다 </param>
    private void OpenPanel(UIType type)
    {
        if (type == UIType.NonePanel)
        {
            if (PanelActiveQueue.Count > 0)
            {
                foreach (var panel in PanelActiveQueue)
                {
                    panel.gameObject.SetActive(false);
                }
                PanelActiveQueue.Clear();
            }
        }

        if (PanelDictionary.TryGetValue(type, out GameObject obj) && type != UIType.NonePanel)
        {
            if (PanelActiveQueue.Contains(obj))
            {
                obj.SetActive(false);
                PanelActiveQueue.Clear();
            }
            else
            {
                if (PanelActiveQueue.Count > 0)
                {
                    var removeObj = PanelActiveQueue.Peek();
                    removeObj.SetActive(false);
                    PanelActiveQueue.Dequeue();
                }

                PanelActiveQueue.Enqueue(obj);
                obj.SetActive(true);
            }
        }
    }


    /// <summary>
    /// 오로지 1개만 열려야 하는 Panel 모음
    /// 즉, 해당 Panel이 열리면 나머지 Panel은 자동으로 닫히는 서로 독립적인 Panel 모음
    /// </summary>
    private enum UIType
    {
        NonePanel = 0,

        InventoryPanel,
        PlayModePanel,
        OptionPanel,
    }
    #endregion
}
